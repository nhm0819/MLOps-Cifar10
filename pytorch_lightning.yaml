apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: pytorch-lightning-training-pipeline-
  annotations: {pipelines.kubeflow.org/kfp_sdk_version: 1.8.12, pipelines.kubeflow.org/pipeline_compilation_time: '2022-04-29T15:56:11.309606',
    pipelines.kubeflow.org/pipeline_spec: '{"description": "Cifar 10 dataset pipeline",
      "name": "Pytorch Lightning Training pipeline"}'}
  labels: {pipelines.kubeflow.org/kfp_sdk_version: 1.8.12}
spec:
  entrypoint: pytorch-lightning-training-pipeline
  templates:
  - name: preprocessdata
    container:
      args: [--output_path, /tmp/outputs/output_data/data]
      command: [python3, Dataload/data_load.py]
      image: nhm0819/kfp-pl:latest
    outputs:
      artifacts:
      - {name: preprocessdata-output_data, path: /tmp/outputs/output_data/data}
    metadata:
      annotations: {pipelines.kubeflow.org/task_display_name: Data Preprocess, pipelines.kubeflow.org/component_spec: '{"description":
          "Prepare data for PyTorch training.\n", "implementation": {"container":
          {"args": ["--output_path", {"outputPath": "output_data"}], "command": ["python3",
          "Dataload/data_load.py"], "image": "nhm0819/kfp-pl:latest"}}, "name": "PreProcessData",
          "outputs": [{"description": "The path to the input datasets", "name": "output_data"}]}',
        pipelines.kubeflow.org/component_ref: '{"digest": "770f3ca4997af82aafd2d97846cfba206f364777b2acbca884b0eb8832b2bd1d",
          "url": "Components/data_component.yaml"}'}
      labels:
        pipelines.kubeflow.org/kfp_sdk_version: 1.8.12
        pipelines.kubeflow.org/pipeline-sdk-type: kfp
        pipelines.kubeflow.org/enable_caching: "true"
  - name: pytorch-lightning-training-pipeline
    dag:
      tasks:
      - {name: preprocessdata, template: preprocessdata}
      - name: training
        template: training
        dependencies: [preprocessdata]
        arguments:
          artifacts:
          - {name: preprocessdata-output_data, from: '{{tasks.preprocessdata.outputs.artifacts.preprocessdata-output_data}}'}
  - name: training
    container:
      args: [--dataset_path, /tmp/inputs/dataset_path/data, --model, resnet50, --gpus,
        '-1', --max_epochs, '30', --num_classes, '10', --train_batch_size, '256',
        --train_num_workers, '8', --val_batch_size, '256', --val_num_workers, '8',
        --lr, '0.001', --checkpoint_dir, /tmp/outputs/checkpoint_dir/data]
      command: [python3, Training/pl_train.py]
      image: nhm0819/kfp-pl:latest
      resources:
        limits: {nvidia.com/gpu: 1}
      volumeMounts:
      - {mountPath: /dev/shm, name: shm}
    inputs:
      artifacts:
      - {name: preprocessdata-output_data, path: /tmp/inputs/dataset_path/data}
    outputs:
      artifacts:
      - {name: training-checkpoint_dir, path: /tmp/outputs/checkpoint_dir/data}
    metadata:
      annotations: {pipelines.kubeflow.org/task_display_name: Training, pipelines.kubeflow.org/component_spec: '{"description":
          "Pytorch training\n", "implementation": {"container": {"args": ["--dataset_path",
          {"inputPath": "dataset_path"}, "--model", {"inputValue": "model"}, "--gpus",
          {"inputValue": "gpus"}, "--max_epochs", {"inputValue": "max_epochs"}, "--num_classes",
          {"inputValue": "num_classes"}, "--train_batch_size", {"inputValue": "train_batch_size"},
          "--train_num_workers", {"inputValue": "train_num_workers"}, "--val_batch_size",
          {"inputValue": "val_batch_size"}, "--val_num_workers", {"inputValue": "val_num_workers"},
          "--lr", {"inputValue": "lr"}, "--checkpoint_dir", {"outputPath": "checkpoint_dir"}],
          "command": ["python3", "Training/pl_train.py"], "image": "nhm0819/kfp-pl:latest"}},
          "inputs": [{"description": "Input dataset path", "name": "dataset_path"},
          {"description": "model structure name in timm package", "name": "model"},
          {"description": "number of using gpus", "name": "gpus"}, {"description":
          "training epochs", "name": "max_epochs"}, {"description": "number of dataset
          classes", "name": "num_classes"}, {"description": "train dataset batch size",
          "name": "train_batch_size"}, {"description": "train dataloader num workers",
          "name": "train_num_workers"}, {"description": "val dataset batch size",
          "name": "val_batch_size"}, {"description": "val dataloader num workers",
          "name": "val_num_workers"}, {"description": "learning rate", "name": "lr"}],
          "name": "Training", "outputs": [{"description": "Model checkpoint output",
          "name": "checkpoint_dir"}]}', pipelines.kubeflow.org/component_ref: '{"digest":
          "48dc14b3c0f83b31006b24213b4eea5cc74d021d4402141d51b1d22f937d9d31", "url":
          "Components/train_component.yaml"}', pipelines.kubeflow.org/arguments.parameters: '{"gpus":
          "-1", "lr": "0.001", "max_epochs": "30", "model": "resnet50", "num_classes":
          "10", "train_batch_size": "256", "train_num_workers": "8", "val_batch_size":
          "256", "val_num_workers": "8"}'}
      labels:
        pipelines.kubeflow.org/kfp_sdk_version: 1.8.12
        pipelines.kubeflow.org/pipeline-sdk-type: kfp
        pipelines.kubeflow.org/enable_caching: "true"
    volumes:
    - emptyDir: {medium: Memory}
      name: shm
  arguments:
    parameters: []
  serviceAccountName: pipeline-runner
